---
title: "Seurat_Part4_dataextraction"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## R Markdown

```{r}
library(Seurat)
dir<-"~/Desktop/LD_AVM02/Data"
setwd(dir)
library(ggplot2)
filename<-"MG_Part3.RData"
load(file=filename)
MG
```

Get means of each marker gene per cluster (in the cluster, out of the cluster)
```{r}
getGeneClusterMeans <- function(gene, cluster){
  x <- GetAssayData(MG,slot = 'data')[gene,]
  m <- tapply(x, ifelse(MG$celltypecluster == cluster, 1, 0), mean)
  mean.in.cluster <- m[2]
  mean.out.of.cluster <- m[1]
  return(list(mean.in.cluster = mean.in.cluster, mean.out.of.cluster = mean.out.of.cluster))
}

markers_all = read.csv("~/Desktop/LD_AVM02/spreadsheets/allmarkersMG_0920.csv",stringsAsFactors = F)
## for sake of time only using first six (head)
means <- mapply(getGeneClusterMeans, markers_all[,"gene"], markers_all[,"cluster"])
means <- matrix(unlist(means), ncol = 2, byrow = T)

colnames(means) <- c("mean.in.cluster", "mean.out.of.cluster")
markers_all2 <- cbind(markers_all, means)
head(markers_all2)
write.csv(markers_all2,"geneclustermeans.csv")
```



Adding in a new metadata column representing samples within clusters

```{r}
samplecluster = paste(MG$celltypecluster,MG$sample_description,sep = '-')
mouseIDfull = paste(samplecluster, MG$sex)
MG$samplecluster = samplecluster
MG$mouseIDfull = mouseIDfull
```

Subsetting samples - could extract a particular cluster using your new metadata column
```{r}
mgAVM02 = subset(MG,subset = celltype == "microglia")
cellnames = colnames(mgAVM02)
ctrl5 = cellnames[grep("5C",cellnames)]
ctrl5 = sample(ctrl5,3400)
ctrl7 = cellnames[grep("7C",cellnames)]
ctrl7 = sample(ctrl7,3400)
dep5 = cellnames[grep("5D",cellnames)]
dep5 = sample(dep5,3400)
dep7 = cellnames[grep("7D",cellnames)]
dep7 = sample(dep7,3400)
cellnames = c(ctrl5,ctrl7,dep5,dep7)
length(cellnames)
mgAVM02 = subset(mgAVM02,cells = cellnames)

Idents(mgAVM02)="sample_description"
markersp7Dep = FindMarkers(mgAVM02, ident.1=c('P7_Deprived'), ident.2 = 'P7_Control',only.pos=F)
dim(markersp7Dep)
head(markersp7Dep)
write.csv(markersp7Dep ,"markersp7Dep.csv")

markersp5Dep = FindMarkers(mgAVM02, ident.1=c('P5_Deprived'), ident.2 = 'P5_Control',only.pos=F)
dim(markersp7Dep)
head(markersp7Dep)
write.csv(markersp7Dep ,"markersp5Dep.csv")
```
```{r}
DimPlot(mgAVM02,group.by = "sample_description")
DimPlot(mgAVM02,split.by = "sample_description",group.by = "seurat_clusters",label = T) + NoLegend()
FeaturePlot(mgAVM02,split.by = "sample_description",features = c("P2ry12"))
FeaturePlot(mgAVM02,split.by = "sample_description",features = c("Cd68"))
FeaturePlot(mgAVM02,split.by = "sample_description",features = c("Ctsd"))
FeaturePlot(mgAVM02,split.by = "sample_description",features = c("Ctsf"))
FeaturePlot(mgAVM02,split.by = "sample_description",features = c("Adora3"))
FeaturePlot(mgAVM02,split.by = "sample_description",features = c("P2ry13"))
```
```{r}
t = table(mgAVM02$sample_description,mgAVM02$seurat_clusters)
t = t[1:4,c(1:4,6,8:10,12,14,17:18)]
t = cbind(t,"sum" = rowSums(t))
t = rbind(t,"sum" = colSums(t))
t
```
Brief summary: 0 = same; 1 - double P7, slightly higher in control; 2 - P5 control; 3 - P5 dep vs ctrl; 5 - P7 deprived; 7 - very slightly P7; 8 - P7; 9 - P5 control; very low in P7 deprived; 11- P5 deprived; 13 - P7 deprived; 16 - low #; 17 - low #

**Interesting:**
P7 v P5: 1,8
P5 Ctrl: 2, 9
P5 Dep: 11, 3*
P7 Dep: 13, 5*, 9**
* = only different in comparison to its own age
** = down


```{r}
filename = "mgonlyAVM02.RData"
save(mgAVM02,file = filename)
```


#rownames(experiment.aggregate@meta.data) are cells
#TSNEPlot(object = experiment.sort_contra, group.by="ident", pt.size=0.5, do.label = F)

#FeaturePlot(experiment.sort_contra, features.plot=c('Sparcl1'), pt.size=0.5)
#FeaturePlot(experiment.sort_contra, features.plot=c('Sparc'), pt.size=0.5)



```{r}
table(MG$bias,MG$celltype)

DimPlot(MG,group.by = "celltypecluster")
DimPlot(MG,group.by = "sample_description")
FeaturePlot(MG,features = c("P2ry12","Adora3","Ctsf","Ctsd"))
FeaturePlot(MG,features = c("Nrxn1","Ncan","Gria2","Ptprz1"))
```


```{r}
filename<-"MG_Part4.RData"
save(MG,file=filename)
```

```{r}
sessionInfo()
```



Downsample all the groups so that they have the same number of cells: 

```{r}
cellnames = colnames(MG)
ctrl5 = cellnames[grep("5C",cellnames)]
ctrl5 = sample(ctrl5,4400)
ctrl7 = cellnames[grep("7C",cellnames)]
ctrl7 = sample(ctrl7,4400)
dep5 = cellnames[grep("5D",cellnames)]
dep5 = sample(dep5,4400)
dep7 = cellnames[grep("7D",cellnames)]
dep7 = sample(dep7,4400)

cellnames = c(ctrl5,ctrl7,dep5,dep7)
length(cellnames)

MG_sub = subset(MG,cells = cellnames)

```
```{r}
DimPlot(MG_sub, reduction = "umap", group.by = "celltypecluster",split.by = "sample_description")
```
```{r}
#Now downsample so that microglia numbers are equal: 
Idents(MG) = "celltype"
MG_only = subset(MG,idents = "microglia")
cellnames = colnames(MG_only)
ctrl5 = cellnames[grep("5C",cellnames)]
ctrl5 = sample(ctrl5,3400)
ctrl7 = cellnames[grep("7C",cellnames)]
ctrl7 = sample(ctrl7,3400)
dep5 = cellnames[grep("5D",cellnames)]
dep5 = sample(dep5,3400)
dep7 = cellnames[grep("7D",cellnames)]
dep7 = sample(dep7,3400)

cellnames = c(ctrl5,ctrl7,dep5,dep7)
length(cellnames)

MG_sub = subset(MG_only,cells = cellnames)
```

Violin plots of interesting genes

```{r}
Idents(MG_sub) = "celltype"
VlnPlot(MG_sub,c("Ctsf","Ctsa","Ctsh","Ctsd","Ctss","Ctsb"),group.by = "sample_description",idents ="microglia", pt.size = F)
VlnPlot(MG_sub,c("Ctsf","Ctsa","Ctsh","Ctsd","Ctss","Ctsb"),group.by = "sample_description",idents ="microglia",pt.size = 0.01)
VlnPlot(MG_sub,c("P2ry12","Adora3","P2ry13","Ctsd","Il13ra1","Il4ra"),group.by = "sample_description",idents ="microglia",pt.size = 0.01)
VlnPlot(MG_sub,c("P2ry12","Adora3","P2ry13","Ctsd","Il13ra1","Il4ra"),group.by = "sample_description",idents ="microglia",pt.size = F)
```
```{r}
DimPlot(MG_sub, reduction = "umap", group.by = "seurat_clusters",split.by = "sample_description",label = T)
```

```{r}
FeaturePlot(MG_sub,c("Ctsf"),split.by = "sample_description",ncol = 2)
FeaturePlot(MG_sub,c("Ctsa"),split.by = "sample_description",ncol = 2)
FeaturePlot(MG_sub,c("Ctsb"),split.by = "sample_description",ncol = 2)
FeaturePlot(MG_sub,c("Ctsh"),split.by = "sample_description",ncol = 2)
FeaturePlot(MG_sub,c("Ctsd","Ctss"),split.by = "sample_description")
FeaturePlot(MG_sub,c("P2ry12","P2ry13"),split.by = "sample_description")
FeaturePlot(MG_sub,c("Adora3","Cx3cr1"),split.by = "sample_description")
FeaturePlot(MG_sub,c("Il13ra1","Il4ra"),split.by = "sample_description")
```


```{r}
table(MG_sub$celltypecluster,MG_sub$sample_description)
```
Microglia _1 = higher in P7
Microglia_11 - only P5 Dep
Microglia_13: higher in P7 Dep
Microglia_2: higher in P5 Ctrl
Microglia_3: higher in P5 Dep
Microglia_5: higher in P7 Dep
Microglia_8: higher in P7
Microglia_9: higher in P5, ctrl

```{r}
setwd("~/Desktop/LD_AVM02/spreadsheets/downsample")
Idents(MG_only) = "celltypecluster"
markersMicro11 = FindMarkers(MG_only, ident.1=c('microglia_11'),only.pos=F)
dim(markersMicro11)
head(markersMicro11)
write.csv(markersMicro11,"markersdep5micro11.csv")

markersMicro1 = FindMarkers(MG_only, ident.1 = 'microglia_1', only.pos=F)
dim(markersMicro1 )
head(markersMicro1 )
write.csv(markersMicro1 ,"markersp7micro1.csv")

markersMicro8 = FindMarkers(MG_only, ident.1 = 'microglia_8', only.pos=F)
dim(markersMicro8 )
head(markersMicro8 )
write.csv(markersMicro8 ,"markersp7micro8.csv")

markersMicro9 = FindMarkers(MG_only, ident.1=c('microglia_9'), only.pos=F)
dim(markersMicro9 )
head(markersMicro9 )
write.csv(markersMicro9 ,"markersctrl_&p5micro9.csv")

markersMicro13 = FindMarkers(MG_only, ident.1=c('microglia_13'), only.pos=F)
dim(markersMicro13)
head(markersMicro13)
write.csv(markersMicro13 ,"markersdep7micro13.csv")

markersMicro2 = FindMarkers(MG_only, ident.1=c('microglia_2'),only.pos=F)
dim(markersMicro2)
head(markersMicro2)
write.csv(markersMicro2,"markersp5ctrlmicro2.csv")

markersMicro3 = FindMarkers(MG_only, ident.1=c('microglia_3'),only.pos=F)
dim(markersMicro3)
head(markersMicro3)
write.csv(markersMicro3,"markersp5depmicro3.csv")

markersMicro5 = FindMarkers(MG_only, ident.1=c('microglia_5'),only.pos=F)
dim(markersMicro5)
head(markersMicro5)
write.csv(markersMicro5,"markersp7depmicro5.csv")
```
```{r}
Idents(MG_sub) = "seurat_clusters"
markers_all <- FindAllMarkers(
    object = MG_sub, 
    only.pos = TRUE, 
    min.pct = 0.25, #gene must be present in 25% of the cells in the cluster
    logfc.threshold = 0.25
)

dim(markers_all)
head(markers_all)
write.csv(markers_all,"allmarkersMGonly_0920.csv")
table(table(markers_all$gene)) #basically a histogram of how many genes are present in how many clusters


markers_all_single <- markers_all[markers_all$gene %in% names(table(markers_all$gene))[table(markers_all$gene) == 1],] #markers that define a single cluster
write.csv(markers_all_single,"singlemarkersMGonly_0920.csv")
dim(markers_all_single)
table(table(markers_all_single$gene))

table(markers_all_single$cluster)

head(markers_all_single)

```